name: ğŸ¤– Gemini AI Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  code-review:
    runs-on: ubuntu-latest
    name: AI Code Review
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v44
        with:
          files: |
            **/*.cs
            **/*.shader
            **/*.json
            **/*.yml
            **/*.yaml

      - name: Setup Node.js
        if: steps.changed-files.outputs.any_changed == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Create review script
        if: steps.changed-files.outputs.any_changed == 'true'
        run: |
          cat << 'EOF' > review.mjs
          import https from 'https';
          import fs from 'fs';

          const GEMINI_API_KEY = process.env.GEMINI_API_KEY;
          const changedFiles = process.env.CHANGED_FILES.split(' ').filter(f => f);

          async function getFileContent(filePath) {
            try {
              return fs.readFileSync(filePath, 'utf8');
            } catch (e) {
              return null;
            }
          }

          async function reviewWithGemini(code, fileName) {
            const prompt = `ë‹¹ì‹ ì€ Unity ê²Œì„ ê°œë°œ ì „ë¬¸ ì½”ë“œ ë¦¬ë·°ì–´ì…ë‹ˆë‹¤.
          
          ë‹¤ìŒ ì½”ë“œë¥¼ ë¦¬ë·°í•´ì£¼ì„¸ìš”. í•œêµ­ì–´ë¡œ ë‹µë³€í•´ì£¼ì„¸ìš”.
          
          íŒŒì¼ëª…: ${fileName}
          
          \`\`\`
          ${code}
          \`\`\`
          
          ë‹¤ìŒ í•­ëª©ë“¤ì„ ê²€í† í•´ì£¼ì„¸ìš”:
          1. ğŸ› ë²„ê·¸ ê°€ëŠ¥ì„±
          2. âš¡ ì„±ëŠ¥ ê°œì„ ì 
          3. ğŸ® Unity ë² ìŠ¤íŠ¸ í”„ë™í‹°ìŠ¤
          4. ğŸ“ ì½”ë“œ ê°€ë…ì„±
          5. ğŸ”’ ì ì¬ì  ë³´ì•ˆ ì´ìŠˆ
          
          ê° í•­ëª©ì— ëŒ€í•´ ê°„ê²°í•˜ê²Œ í”¼ë“œë°±ì„ ì£¼ê³ , ê°œì„ ì´ í•„ìš”í•˜ë©´ ìˆ˜ì •ëœ ì½”ë“œ ì˜ˆì‹œë„ ì œê³µí•´ì£¼ì„¸ìš”.
          ë¬¸ì œê°€ ì—†ë‹¤ë©´ "âœ… ì¢‹ìŠµë‹ˆë‹¤!"ë¼ê³  ë‹µë³€í•´ì£¼ì„¸ìš”.`;

            return new Promise((resolve, reject) => {
              const data = JSON.stringify({
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: {
                  temperature: 0.3,
                  maxOutputTokens: 2048
                }
              });

              const options = {
                hostname: 'generativelanguage.googleapis.com',
                path: `/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`,
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'Content-Length': Buffer.byteLength(data)
                }
              };

              const req = https.request(options, (res) => {
                let body = '';
                res.on('data', chunk => body += chunk);
                res.on('end', () => {
                  try {
                    const json = JSON.parse(body);
                    const text = json.candidates?.[0]?.content?.parts?.[0]?.text || 'ë¦¬ë·°ë¥¼ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
                    resolve(text);
                  } catch (e) {
                    resolve('API ì‘ë‹µ íŒŒì‹± ì‹¤íŒ¨: ' + e.message);
                  }
                });
              });

              req.on('error', reject);
              req.write(data);
              req.end();
            });
          }

          async function main() {
            let reviews = [];
            
            console.log('ğŸ“ ë¦¬ë·°í•  íŒŒì¼ë“¤:', changedFiles);
            
            for (const file of changedFiles) {
              const content = await getFileContent(file);
              if (content && content.length < 10000) {
                console.log(`ğŸ” ë¦¬ë·° ì¤‘: ${file}`);
                const review = await reviewWithGemini(content, file);
                reviews.push(`## ğŸ“„ \`${file}\`\n\n${review}`);
              }
            }

            if (reviews.length === 0) {
              reviews.push('ë¦¬ë·°í•  ì½”ë“œ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.');
            }

            const finalReview = `# ğŸ¤– Gemini AI ì½”ë“œ ë¦¬ë·°\n\n${reviews.join('\n\n---\n\n')}`;
            
            fs.writeFileSync('review_output.md', finalReview);
            console.log('âœ… ë¦¬ë·° ì™„ë£Œ!');
          }

          main().catch(console.error);
          EOF

      - name: Run Gemini review
        if: steps.changed-files.outputs.any_changed == 'true'
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          CHANGED_FILES: ${{ steps.changed-files.outputs.all_changed_files }}
        run: node review.mjs

      - name: Post review comment
        if: steps.changed-files.outputs.any_changed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const review = fs.readFileSync('review_output.md', 'utf8');
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: review
            });

      - name: No files to review
        if: steps.changed-files.outputs.any_changed != 'true'
        run: echo "ğŸ“­ ë¦¬ë·°í•  ì½”ë“œ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤."
