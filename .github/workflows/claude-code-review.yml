name: ğŸ¤– Claude AI Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  code-review:
    runs-on: ubuntu-latest
    name: AI Code Review
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v44
        with:
          files: |
            **/*.cs
            **/*.shader
            **/*.json
            **/*.yml
            **/*.yaml

      - name: Setup Node.js
        if: steps.changed-files.outputs.any_changed == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Create review script
        if: steps.changed-files.outputs.any_changed == 'true'
        run: |
          cat << 'EOF' > review.mjs
          import https from 'https';
          import fs from 'fs';

          const ANTHROPIC_API_KEY = process.env.ANTHROPIC_API_KEY;
          const changedFiles = process.env.CHANGED_FILES.split(' ').filter(f => f);

          async function getFileContent(filePath) {
            try {
              return fs.readFileSync(filePath, 'utf8');
            } catch (e) {
              return null;
            }
          }

          async function reviewWithClaude(code, fileName) {
            const prompt = `ë‹¹ì‹ ì€ Unity ê²Œì„ ê°œë°œ ì „ë¬¸ ì½”ë“œ ë¦¬ë·°ì–´ì…ë‹ˆë‹¤. ëª¨ë“  ë¦¬ë·°ëŠ” ë°˜ë“œì‹œ í•œêµ­ì–´ë¡œ ì‘ì„±í•´ì•¼ í•©ë‹ˆë‹¤.

## íŒŒì¼ ì •ë³´
- **íŒŒì¼ëª…:** ${fileName}

## ë¦¬ë·° ëŒ€ìƒ ì½”ë“œ
\`\`\`csharp
${code}
\`\`\`

## ğŸ“‹ í•„ìˆ˜ ê²€í†  í•­ëª©

### 1. ğŸ›ï¸ SOLID ì›ì¹™ ê²€í† 
ê° ì›ì¹™ ìœ„ë°˜ ì—¬ë¶€ë¥¼ í™•ì¸í•˜ê³  êµ¬ì²´ì ì¸ í”¼ë“œë°±ì„ ì œê³µí•˜ì„¸ìš”:
- **SRP (ë‹¨ì¼ ì±…ì„ ì›ì¹™):** í´ë˜ìŠ¤ê°€ ë‹¨ í•˜ë‚˜ì˜ ë³€ê²½ ì´ìœ ë§Œ ê°€ì§€ëŠ”ê°€?
- **OCP (ê°œë°©-íì‡„ ì›ì¹™):** í™•ì¥ì— ì—´ë ¤ìˆê³  ìˆ˜ì •ì— ë‹«í˜€ìˆëŠ”ê°€?
- **LSP (ë¦¬ìŠ¤ì½”í”„ ì¹˜í™˜ ì›ì¹™):** í•˜ìœ„ íƒ€ì…ì´ ìƒìœ„ íƒ€ì…ì„ ëŒ€ì²´í•  ìˆ˜ ìˆëŠ”ê°€?
- **ISP (ì¸í„°í˜ì´ìŠ¤ ë¶„ë¦¬ ì›ì¹™):** ì¸í„°í˜ì´ìŠ¤ê°€ ë‹¨ì¼ ëª©ì ìœ¼ë¡œ ì‘ê²Œ ë¶„ë¦¬ë˜ì–´ ìˆëŠ”ê°€?
- **DIP (ì˜ì¡´ì„± ì—­ì „ ì›ì¹™):** ì¶”ìƒí™”ì— ì˜ì¡´í•˜ê³  ìˆëŠ”ê°€?

### 2. ğŸ”— ë””ë¯¸í„°ì˜ ë²•ì¹™ (Law of Demeter) ê²€í† 
- \`a.getB().getC().doSomething()\` ê°™ì€ "ê¸°ì°¨ ì°¸ì‚¬(Train Wreck)" íŒ¨í„´ì´ ìˆëŠ”ê°€?
- ê°ì²´ê°€ ì˜¤ì§ ê°€ì¥ ê°€ê¹Œìš´ ì¹œêµ¬ì™€ë§Œ ëŒ€í™”í•˜ëŠ”ê°€?

### 3. ğŸ§¹ ë³´ì´ìŠ¤ì¹´ìš°íŠ¸ ì›ì¹™ ê²€í† 
- ì½”ë“œê°€ ì´ì „ë³´ë‹¤ ë” ê¹¨ë—í•´ì¡ŒëŠ”ê°€?
- ì¤‘ë³µ ì½”ë“œ, ë¯¸ì‚¬ìš© ë³€ìˆ˜, ì£½ì€ ì½”ë“œ(dead code)ê°€ ìˆëŠ”ê°€?
- ë¶ˆí•„ìš”í•œ ë³µì¡ì„±ì´ ìˆëŠ”ê°€?

### 4. ğŸ·ï¸ ëª…ëª… ê·œì¹™ ê²€í† 
- **PascalCase:** í´ë˜ìŠ¤, êµ¬ì¡°ì²´, ì¸í„°í˜ì´ìŠ¤(Iì ‘ë‘ì‚¬), ê³µìš© ë©¤ë²„, ì†ì„±, ë©”ì„œë“œ, ìƒìˆ˜
- **camelCase:** ë©”ì„œë“œ ë§¤ê°œë³€ìˆ˜, ì§€ì—­ ë³€ìˆ˜
- **Private í•„ë“œ:** \`_\` ì ‘ë‘ì‚¬ + camelCase (ì˜ˆ: \`_workerQueue\`)
- **ì •ì  í•„ë“œ:** \`s_\` ì ‘ë‘ì‚¬ (ì˜ˆ: \`s_defaultLogger\`)
- ì˜ë¯¸ ìˆê³  ì„¤ëª…ì ì¸ ì´ë¦„ì„ ì‚¬ìš©í•˜ëŠ”ê°€?

### 5. ğŸ“ ë ˆì´ì•„ì›ƒ ê·œì¹™ ê²€í† 
- ë“¤ì—¬ì“°ê¸°: 4ê°œì˜ ê³µë°± ì‚¬ìš© (íƒ­ ê¸ˆì§€)
- ì¤‘ê´„í˜¸: Allman ìŠ¤íƒ€ì¼ (ì—¬ëŠ” ì¤‘ê´„í˜¸ê°€ ìƒˆ ì¤„ì— ìœ„ì¹˜)
- í•œ ì¤„ì— í•˜ë‚˜ì˜ ë¬¸ì¥ë§Œ ì‘ì„±
- XML ì£¼ì„ ëŒ€ì‹  ì„¤ëª…ì ì¸ ë©”ì„œë“œëª…/ë§¤ê°œë³€ìˆ˜ëª… ì‚¬ìš©

### 6. ğŸ® Unity ë² ìŠ¤íŠ¸ í”„ë™í‹°ìŠ¤
- Update()ì—ì„œ ë¶ˆí•„ìš”í•œ ì—°ì‚°ì´ ìˆëŠ”ê°€?
- GetComponent ìºì‹±ì´ ì ì ˆí•œê°€?
- ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ ê°€ëŠ¥ì„±ì´ ìˆëŠ”ê°€?

### 7. âš¡ ì„±ëŠ¥ ë° ë²„ê·¸
- ì ì¬ì  ë²„ê·¸ê°€ ìˆëŠ”ê°€?
- ì„±ëŠ¥ ê°œì„ ì´ í•„ìš”í•œ ë¶€ë¶„ì´ ìˆëŠ”ê°€?

## ğŸ“ ì¶œë ¥ í˜•ì‹

ê° í•­ëª©ë³„ë¡œ ë‹¤ìŒ í˜•ì‹ìœ¼ë¡œ í”¼ë“œë°±ì„ ì œê³µí•˜ì„¸ìš”:
- âœ… **ì¤€ìˆ˜:** ë¬¸ì œì—†ìŒ
- âš ï¸ **ê°œì„  ê¶Œì¥:** ê°œì„ ì´ í•„ìš”í•œ ë¶€ë¶„ê³¼ ìˆ˜ì • ì˜ˆì‹œ
- âŒ **ìœ„ë°˜:** ì‹¬ê°í•œ ìœ„ë°˜ ì‚¬í•­ê³¼ ë°˜ë“œì‹œ ìˆ˜ì •í•´ì•¼ í•  ì½”ë“œ

ë¬¸ì œê°€ ë°œê²¬ë˜ë©´ **ìˆ˜ì •ëœ ì½”ë“œ ì˜ˆì‹œ**ë¥¼ ë°˜ë“œì‹œ ì œê³µí•˜ì„¸ìš”.
ëª¨ë“  í”¼ë“œë°±ì€ **í•œêµ­ì–´**ë¡œ ì‘ì„±í•˜ì„¸ìš”.`;

            return new Promise((resolve, reject) => {
              const data = JSON.stringify({
                model: 'claude-sonnet-4-20250514',
                max_tokens: 4096,
                messages: [
                  {
                    role: 'user',
                    content: prompt
                  }
                ]
              });

              const options = {
                hostname: 'api.anthropic.com',
                path: '/v1/messages',
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'x-api-key': ANTHROPIC_API_KEY,
                  'anthropic-version': '2023-06-01'
                }
              };

              const req = https.request(options, (res) => {
                let body = '';
                res.on('data', chunk => body += chunk);
                res.on('end', () => {
                  try {
                    const json = JSON.parse(body);
                    if (json.error) {
                      resolve('API ì˜¤ë¥˜: ' + json.error.message);
                      return;
                    }
                    const text = json.content?.[0]?.text || 'ë¦¬ë·°ë¥¼ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
                    resolve(text);
                  } catch (e) {
                    resolve('API ì‘ë‹µ íŒŒì‹± ì‹¤íŒ¨: ' + e.message);
                  }
                });
              });

              req.on('error', reject);
              req.write(data);
              req.end();
            });
          }

          async function main() {
            let reviews = [];
            
            console.log('ğŸ“ ë¦¬ë·°í•  íŒŒì¼ë“¤:', changedFiles);
            
            for (const file of changedFiles) {
              const content = await getFileContent(file);
              if (content && content.length < 15000) {
                console.log(`ğŸ” ë¦¬ë·° ì¤‘: ${file}`);
                const review = await reviewWithClaude(content, file);
                reviews.push(`## ğŸ“„ \`${file}\`\n\n${review}`);
              }
            }

            if (reviews.length === 0) {
              reviews.push('ë¦¬ë·°í•  ì½”ë“œ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.');
            }

            const header = `# ğŸ¤– Claude AI ì½”ë“œ ë¦¬ë·°

> ì´ ë¦¬ë·°ëŠ” [C# ì½”ë”© ì»¨ë²¤ì…˜ ë° ìŠ¤íƒ€ì¼ ê°€ì´ë“œ](../docs/STYLE_GUIDE.md)ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ìë™ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.
> **Model:** Claude Sonnet 4 (claude-sonnet-4-20250514)

## ğŸ“‹ ê²€í†  ê¸°ì¤€
| í•­ëª© | ì„¤ëª… |
|------|------|
| ğŸ›ï¸ SOLID | ê°ì²´ ì§€í–¥ ì„¤ê³„ 5ì›ì¹™ |
| ğŸ”— LoD | ë””ë¯¸í„°ì˜ ë²•ì¹™ |
| ğŸ§¹ Boy Scout | ë³´ì´ìŠ¤ì¹´ìš°íŠ¸ ì›ì¹™ |
| ğŸ·ï¸ Naming | ëª…ëª… ê·œì¹™ |
| ğŸ“ Layout | ë ˆì´ì•„ì›ƒ ê·œì¹™ |
| ğŸ® Unity | Unity ë² ìŠ¤íŠ¸ í”„ë™í‹°ìŠ¤ |

---

`;
            
            const finalReview = header + reviews.join('\n\n---\n\n');
            
            fs.writeFileSync('review_output.md', finalReview);
            console.log('âœ… ë¦¬ë·° ì™„ë£Œ!');
          }

          main().catch(console.error);
          EOF

      - name: Run Claude review
        if: steps.changed-files.outputs.any_changed == 'true'
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          CHANGED_FILES: ${{ steps.changed-files.outputs.all_changed_files }}
        run: node review.mjs

      - name: Post review comment
        if: steps.changed-files.outputs.any_changed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const review = fs.readFileSync('review_output.md', 'utf8');
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: review
            });

      - name: No files to review
        if: steps.changed-files.outputs.any_changed != 'true'
        run: echo "ğŸ“­ ë¦¬ë·°í•  ì½”ë“œ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤."
